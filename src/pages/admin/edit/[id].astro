---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import MediaPicker from '../../../components/MediaPicker.astro';
import { getProjectById, updateProject } from '../../../db/queries';
// sharp import removed to allow dynamic loading
import fs from 'fs/promises';
import path from 'path';
import { v4 as uuidv4 } from 'uuid';

const cookie = Astro.cookies.get('auth_token');
if (!cookie) {
  return Astro.redirect('/admin/login');
}

const { id } = Astro.params;
if (!id) return Astro.redirect('/admin');

const project = await getProjectById(id);

if (!project) return Astro.redirect('/admin'); // Handle not found

// Parse Images for display
let currentImages: string[] = [];
try {
    const parsed = JSON.parse(project.images || '[]');
    if (Array.isArray(parsed)) {
        currentImages = parsed;
    } else if (project.images) {
        currentImages = [project.images];
    }
} catch (e) {
    if (project.images) currentImages = [project.images];
}

const currentCover = currentImages.length > 0 ? currentImages[0] : null;
const currentGallery = currentImages.length > 1 ? currentImages.slice(1) : [];

if (Astro.request.method === "POST") {
    try {
        const formData = await Astro.request.formData();
        const title = formData.get("title")?.toString() || "";
        const slug = formData.get("slug")?.toString() || "";
        const category = formData.get("category")?.toString() || "";
        const year = formData.get("year")?.toString() || "";
        const location = formData.get("location")?.toString() || "";
        const area = formData.get("area")?.toString() || "";
        const description = formData.get("description")?.toString() || "";
        
        // Check if images were selected from library
        const coverLibrary = formData.get("new_cover_image_library")?.toString();
        const galleryLibrary = formData.get("new_gallery_images_library")?.toString();
        
        // Handle New File Uploads
        const newCoverFile = formData.get('new_cover_image') as File;
        const newGalleryFiles = formData.getAll('new_gallery_images') as File[];
        
        // Process kept gallery images (from hidden input)
        let keptGallery: string[] = [];
        const keptImagesRaw = formData.get("kept_gallery_images")?.toString();
        if (keptImagesRaw) {
             try {
                 keptGallery = JSON.parse(keptImagesRaw);
             } catch {}
        }
        
        // 1. Determine Cover Image
        // If a new cover is uploaded, it becomes the first image.
        // If not, we keep the old cover (if it exists) unless there was logic to delete it (which we don't really support, a project needs a cover).
        // Let's assume: kept cover is implicit unless replaced.
        
        const uploadDir = path.join(process.cwd(), 'public', 'uploads');
        try {
            await fs.access(uploadDir);
        } catch {
            await fs.mkdir(uploadDir, { recursive: true });
        }

        const processFile = async (file: File) => {
            if (file.size > 0 && file.type.startsWith('image/')) {
                const buffer = Buffer.from(await file.arrayBuffer());
                const filename = `${uuidv4()}-${file.name.replace(/[^a-zA-Z0-9.-]/g, '')}`;
                const filepath = path.join(uploadDir, filename);
                
                try {
                    const sharp = (await import('sharp')).default;
                    await sharp(buffer)
                        .resize(1920, 1080, { fit: 'inside', withoutEnlargement: true })
                        .jpeg({ quality: 80 })
                        .toFile(filepath);
                } catch(err) {
                    console.warn("Sharp optimization failed (or not found), saving raw file:", err);
                    await fs.writeFile(filepath, buffer);
                }
                
                return `/uploads/${filename}`;
            }
            return null;
        }


        let finalCover = currentCover;
        
        // Check if cover was selected from library
        if (coverLibrary) {
            try {
                const libraryUrls = JSON.parse(coverLibrary);
                if (Array.isArray(libraryUrls) && libraryUrls.length > 0) {
                    finalCover = libraryUrls[0];
                }
            } catch {}
        }
        
        // If no library selection, check if user uploaded a new cover
        if (finalCover === currentCover && newCoverFile && newCoverFile.size > 0) {
            const newUrl = await processFile(newCoverFile);
            if (newUrl) finalCover = newUrl;
        }

        let finalGallery: string[] = [...keptGallery];
        
        // Check if gallery was selected from library
        if (galleryLibrary) {
            try {
                const libraryGallery = JSON.parse(galleryLibrary);
                if (Array.isArray(libraryGallery)) {
                    finalGallery.push(...libraryGallery);
                }
            } catch {}
        }
        
        // Process new uploaded gallery images
        for (const file of newGalleryFiles) {
            const url = await processFile(file);
            if (url) finalGallery.push(url);
        }
        
        const allImages = [finalCover, ...finalGallery].filter(img => img !== null) as string[];


        await updateProject(id, {
            title,
            slug,
            category,
            year,
            location,
            area,
            description,
            images: JSON.stringify(allImages),
        });

        return Astro.redirect("/admin");
    } catch (e) {
        console.error("Error updating project:", e);
    }
}
---

<AdminLayout title={`Editar: ${project.title}`}>
    <div class="admin-main admin-container">
        <div class="page-header">
            <h1 class="page-title">Editar Projeto</h1>
            <a href="/admin" class="btn btn-secondary">Cancelar</a>
        </div>

        <div class="card">
            <form method="POST" enctype="multipart/form-data" id="editForm">
                <div class="form-row">
                    <div class="form-group" style="flex: 2;">
                        <label class="form-label" for="title">T√≠tulo</label>
                        <input class="form-input" type="text" id="title" name="title" value={project.title} required />
                    </div>
                    
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label" for="category">Categoria</label>
                        <select class="form-select" id="category" name="category" required>
                            <option value="Residencial" selected={project.category === "Residencial"}>Residencial</option>
                            <option value="Comercial" selected={project.category === "Comercial"}>Comercial</option>
                            <option value="Interiores" selected={project.category === "Interiores"}>Interiores</option>
                            <option value="Urbanismo" selected={project.category === "Urbanismo"}>Urbanismo</option>
                            <option value="Outros" selected={project.category === "Outros"}>Outros</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="slug">Slug (URL)</label>
                    <input class="form-input" type="text" id="slug" name="slug" value={project.slug} required />
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="year">Ano</label>
                        <input class="form-input" type="text" id="year" name="year" value={project.year || ''} />
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="location">Localiza√ß√£o</label>
                        <input class="form-input" type="text" id="location" name="location" value={project.location || ''} />
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="area">√Årea</label>
                        <input class="form-input" type="text" id="area" name="area" value={project.area || ''} />
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="description">Descri√ß√£o</label>
                    <textarea class="form-textarea" id="description" name="description" rows="5">{project.description}</textarea>
                </div>

                <!-- Cover Image -->
                <div class="form-group">
                    <label class="upload-label">Imagem de Capa</label>
                    <div class="upload-area" id="cover-upload-area" onclick="openMediaPicker('new_cover_image', previewCoverFromLibrary, false)">
                        <input type="file" id="new_cover_image" name="new_cover_image" accept="image/*" class="hidden-input" onchange="previewCover(this)" style="display:none;" />
                        <div class="upload-content">
                            {currentCover ? (
                                <div style="margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--admin-text-muted);">
                                    Clique para escolher da biblioteca
                                </div>
                            ) : (
                                <div class="upload-icon">üì∑</div>
                            )}
                            <div class="upload-text">
                                <span class="upload-highlight">Alterar Capa</span>
                            </div>
                        </div>
                        <div class={`cover-preview ${currentCover ? 'active' : ''}`} id="cover-preview-container">
                             <img id="cover-preview-img" src={currentCover || ''} alt="Capa" />
                             <div class="change-overlay">Clique para alterar</div>
                        </div>
                    </div>
                    <div style="margin-top: 0.5rem; text-align: center;">
                        <button type="button" class="btn btn-sm btn-secondary" id="btn-upload-cover">
                            Enviar do PC
                        </button>
                    </div>
                </div>

                <!-- Gallery Images -->
                <div class="form-group">
                    <label class="upload-label">Galeria</label>
                    
                    <!-- Existing Gallery -->
                    {currentGallery.length > 0 && (
                        <div style="margin-bottom: 1rem;">
                            <label class="form-label" style="font-size: 0.85rem; color: var(--admin-text-muted);">Imagens Existentes</label>
                            <div class="current-images-grid" id="existing-gallery-grid">
                            {currentGallery.map((img, index) => (
                                <div class="image-item" id={`gallery-item-${index}`}>
                                    <img src={img} alt={`Galeria ${index}`} />
                                    <button type="button" class="btn-remove-img" onclick={`removeGalleryImage('${img}', 'gallery-item-${index}')`}>√ó</button>
                                </div>
                            ))}
                            </div>
                        </div>
                    )}
                    <input type="hidden" name="kept_gallery_images" id="kept_gallery_images" value={JSON.stringify(currentGallery)} />

                    <!-- Add New -->
                    <div class="upload-area" style="min-height: 120px; border-style: dashed;" onclick="openMediaPicker('new_gallery_images', previewGalleryFromLibrary, true)">
                        <input type="file" id="new_gallery_images" name="new_gallery_images" multiple accept="image/*" class="hidden-input" onchange="previewGallery(this)" style="display:none;" />
                        <div class="upload-content">
                             <div class="upload-icon" style="font-size: 1.5rem;">+</div>
                            <div class="upload-text">
                                <span class="upload-highlight">Escolher da biblioteca</span> ou enviar novas
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 0.5rem; text-align: center;">
                        <button type="button" class="btn btn-sm btn-secondary" id="btn-upload-gallery">
                            Enviar do PC
                        </button>
                    </div>
                    <div class="preview-container" id="gallery-preview-container"></div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Salvar Altera√ß√µes</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Media Picker Modal -->
    <MediaPicker />
</AdminLayout>

<script is:inline>
    // Preview Cover
    function previewCover(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.getElementById('cover-preview-img');
                const container = document.getElementById('cover-preview-container');
                img.src = e.target.result;
                container.classList.add('active');
            }
            reader.readAsDataURL(input.files[0]);
        }
    }
    
    function previewCoverFromLibrary(urls) {
        if (urls && urls.length > 0) {
            const img = document.getElementById('cover-preview-img');
            const container = document.getElementById('cover-preview-container');
            img.src = urls[0];
            container.classList.add('active');
        }
    }

    // Preview New Gallery Items
    function previewGallery(input) {
        const container = document.getElementById('gallery-preview-container');
        container.innerHTML = ''; 
        if (input.files) {
            Array.from(input.files).forEach((file) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const div = document.createElement('div');
                    div.className = 'preview-item';
                    div.innerHTML = `<img src="${e.target.result}" />`;
                    container.appendChild(div);
                }
                reader.readAsDataURL(file);
            });
        }
    }
    
    function previewGalleryFromLibrary(urls) {
        const container = document.getElementById('gallery-preview-container');
        urls.forEach(url => {
            const div = document.createElement('div');
            div.className = 'preview-item';
            div.innerHTML = `<img src="${url}" />`;
            container.appendChild(div);
        });
    }
    
    function handleCoverUploadClick(e) {
        e.stopPropagation();
        document.getElementById('new_cover_image').click();
    }
    
    function handleGalleryUploadClick(e) {
        e.stopPropagation();
        document.getElementById('new_gallery_images').click();
    }
    
    // Attach event listeners
    document.addEventListener('DOMContentLoaded', function() {
        const btnCover = document.getElementById('btn-upload-cover');
        const btnGallery = document.getElementById('btn-upload-gallery');
        
        if (btnCover) {
            btnCover.addEventListener('click', handleCoverUploadClick);
        }
        
        if (btnGallery) {
            btnGallery.addEventListener('click', handleGalleryUploadClick);
        }
    });
</script>

<style>
    .form-row {
        display: flex;
        gap: 1.5rem;
    }
    
    .form-actions {
        margin-top: 2rem;
        display: flex;
        justify-content: flex-end;
    }

    .current-images-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .image-item {
        position: relative;
        border-radius: var(--radius-md);
        overflow: hidden;
        aspect-ratio: 16/9;
        border: 1px solid var(--admin-border);
    }

    .image-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .btn-remove-img {
        position: absolute;
        top: 5px;
        right: 5px;
        background: rgba(239, 68, 68, 0.9);
        color: white;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
    }

    @media (max-width: 768px) {
        .form-row {
            flex-direction: column;
            gap: 0;
        }
    }
</style>

<style>
    /* Reuse Admin Styles */
    .admin-wrapper {
        font-family: Arial, sans-serif;
        background: #fff;
        color: #333;
        min-height: 100vh;
    }

    .admin-header {
        background: #eee;
        padding: 1rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #ddd;
    }

    .admin-content {
        padding: 2rem;
        max-width: 800px;
        margin: 0 auto;
    }

    .create-form {
        display: grid;
        gap: 1.5rem;
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    label {
        font-weight: bold;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
    }

    input, select, textarea {
        padding: 0.8rem;
        border: 1px solid #ccc;
        font-size: 1rem;
        font-family: inherit;
    }

    .btn-save {
        background: black;
        color: white;
        border: none;
        padding: 1rem;
        font-size: 1rem;
        font-weight: bold;
        cursor: pointer;
        text-transform: uppercase;
        margin-top: 1rem;
    }

    .btn-save:hover {
        background: #333;
    }
</style>
