---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import MediaPicker from '../../../components/MediaPicker.astro';
import { getProjectByIdFromCRM } from '../../../lib/crm';
// CRM mode - Mutations disabled

const cookie = Astro.cookies.get('auth_token');
if (!cookie) {
  return Astro.redirect('/admin/login');
}

const { id } = Astro.params;
if (!id) return Astro.redirect('/admin');

const project = await getProjectByIdFromCRM(id);

if (!project) return Astro.redirect('/admin'); // Handle not found

// Parse Images for display
let currentImages: string[] = [];
try {
    const parsed = JSON.parse(project.images || '[]');
    if (Array.isArray(parsed)) {
        currentImages = parsed;
    } else if (project.images) {
        currentImages = [project.images];
    }
} catch (e) {
    if (project.images) currentImages = [project.images];
}

const currentCover = currentImages.length > 0 ? currentImages[0] : null;
const currentGallery = currentImages.length > 1 ? currentImages.slice(1) : [];

if (Astro.request.method === "POST") {
    console.warn("Mutations are disabled in the frontend. Please use the CRM management panel.");
    return Astro.redirect("/admin?error=read_only");
}
---

<AdminLayout title={`Editar: ${project.title}`}>
    <div class="page-header-flex">
        <div>
            <h1 class="page-title-large">Editar Projeto</h1>
            <p class="page-subtitle">Fa√ßa altera√ß√µes no projeto {project.title}.</p>
        </div>
        <a href="/admin" class="btn btn-secondary">Cancelar</a>
    </div>

    <div class="card fade-in">
            <form method="POST" enctype="multipart/form-data" id="editForm">
                <div class="form-row">
                    <div class="form-group" style="flex: 2;">
                        <label class="form-label" for="title">T√≠tulo</label>
                        <input class="form-input" type="text" id="title" name="title" value={project.title} required />
                    </div>
                    
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label" for="category">Categoria</label>
                        <select class="form-select" id="category" name="category" required>
                            <option value="Residencial" selected={project.category === "Residencial"}>Residencial</option>
                            <option value="Comercial" selected={project.category === "Comercial"}>Comercial</option>
                            <option value="Interiores" selected={project.category === "Interiores"}>Interiores</option>
                            <option value="Urbanismo" selected={project.category === "Urbanismo"}>Urbanismo</option>
                            <option value="Outros" selected={project.category === "Outros"}>Outros</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="slug">Slug (URL)</label>
                    <input class="form-input" type="text" id="slug" name="slug" value={project.slug} required />
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="year">Ano</label>
                        <input class="form-input" type="text" id="year" name="year" value={project.year || ''} />
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="location">Localiza√ß√£o</label>
                        <input class="form-input" type="text" id="location" name="location" value={project.location || ''} />
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="area">√Årea</label>
                        <input class="form-input" type="text" id="area" name="area" value={project.area || ''} />
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="description">Descri√ß√£o</label>
                    <textarea class="form-textarea" id="description" name="description" rows="5">{project.description}</textarea>
                </div>

                <!-- Cover Image -->
                <div class="form-group">
                    <label class="upload-label">Imagem de Capa</label>
                    <div class="upload-area" id="cover-upload-area" onclick="openMediaPicker('new_cover_image', previewCoverFromLibrary, false)">
                        <input type="file" id="new_cover_image" name="new_cover_image" accept="image/*" class="hidden-input" onchange="previewCover(this)" style="display:none;" />
                        <div class="upload-content">
                            {currentCover ? (
                                <div style="margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--admin-text-muted);">
                                    Clique para escolher da biblioteca
                                </div>
                            ) : (
                                <div class="upload-icon">üì∑</div>
                            )}
                            <div class="upload-text">
                                <span class="upload-highlight">Alterar Capa</span>
                            </div>
                        </div>
                        <div class={`cover-preview ${currentCover ? 'active' : ''}`} id="cover-preview-container">
                             <img id="cover-preview-img" src={currentCover || ''} alt="Capa" />
                             <div class="change-overlay">Clique para alterar</div>
                        </div>
                    </div>
                    <div style="margin-top: 0.5rem; text-align: center;">
                        <button type="button" class="btn btn-sm btn-secondary" id="btn-upload-cover">
                            Enviar do PC
                        </button>
                    </div>
                </div>

                <!-- Gallery Images -->
                <div class="form-group">
                    <label class="upload-label">Galeria</label>
                    
                    <!-- Existing Gallery -->
                    {currentGallery.length > 0 && (
                        <div style="margin-bottom: 1rem;">
                            <label class="form-label" style="font-size: 0.85rem; color: var(--admin-text-muted);">Imagens Existentes</label>
                            <div class="current-images-grid" id="existing-gallery-grid">
                            {currentGallery.map((img, index) => (
                                <div class="image-item" id={`gallery-item-${index}`}>
                                    <img src={img} alt={`Galeria ${index}`} />
                                    <button type="button" class="btn-remove-img" onclick={`removeGalleryImage('${img}', 'gallery-item-${index}')`}>√ó</button>
                                </div>
                            ))}
                            </div>
                        </div>
                    )}
                    <input type="hidden" name="kept_gallery_images" id="kept_gallery_images" value={JSON.stringify(currentGallery)} />

                    <!-- Add New -->
                    <div class="upload-area" style="min-height: 120px; border-style: dashed;" onclick="openMediaPicker('new_gallery_images', previewGalleryFromLibrary, true)">
                        <input type="file" id="new_gallery_images" name="new_gallery_images" multiple accept="image/*" class="hidden-input" onchange="previewGallery(this)" style="display:none;" />
                        <div class="upload-content">
                             <div class="upload-icon" style="font-size: 1.5rem;">+</div>
                            <div class="upload-text">
                                <span class="upload-highlight">Escolher da biblioteca</span> ou enviar novas
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 0.5rem; text-align: center;">
                        <button type="button" class="btn btn-sm btn-secondary" id="btn-upload-gallery">
                            Enviar do PC
                        </button>
                    </div>
                    <div class="preview-container" id="gallery-preview-container"></div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Salvar Altera√ß√µes</button>
                </div>
            </form>
        </div>

    
    <!-- Media Picker Modal -->
    <MediaPicker />
</AdminLayout>

<script is:inline>
    // Preview Cover
    function previewCover(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.getElementById('cover-preview-img');
                const container = document.getElementById('cover-preview-container');
                img.src = e.target.result;
                container.classList.add('active');
            }
            reader.readAsDataURL(input.files[0]);
        }
    }
    
    function previewCoverFromLibrary(urls) {
        if (urls && urls.length > 0) {
            const img = document.getElementById('cover-preview-img');
            const container = document.getElementById('cover-preview-container');
            img.src = urls[0];
            container.classList.add('active');
        }
    }

    // Preview New Gallery Items
    function previewGallery(input) {
        const container = document.getElementById('gallery-preview-container');
        // Clear container safely
        while (container.firstChild) {
            container.removeChild(container.firstChild);
        }
        
        if (input.files) {
            Array.from(input.files).forEach((file) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const div = document.createElement('div');
                    div.className = 'preview-item';
                    
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.alt = 'Preview';
                    
                    div.appendChild(img);
                    container.appendChild(div);
                }
                reader.readAsDataURL(file);
            });
        }
    }
    
    function previewGalleryFromLibrary(urls) {
        const container = document.getElementById('gallery-preview-container');
        urls.forEach(url => {
            const div = document.createElement('div');
            div.className = 'preview-item';
            
            const img = document.createElement('img');
            img.src = url; // URL from trusted source
            img.alt = 'Gallery image';
            
            div.appendChild(img);
            container.appendChild(div);
        });
    }
    
    function handleCoverUploadClick(e) {
        e.stopPropagation();
        document.getElementById('new_cover_image').click();
    }
    
    function handleGalleryUploadClick(e) {
        e.stopPropagation();
        document.getElementById('new_gallery_images').click();
    }
    
    // Attach event listeners
    document.addEventListener('DOMContentLoaded', function() {
        const btnCover = document.getElementById('btn-upload-cover');
        const btnGallery = document.getElementById('btn-upload-gallery');
        
        if (btnCover) {
            btnCover.addEventListener('click', handleCoverUploadClick);
        }
        
        if (btnGallery) {
            btnGallery.addEventListener('click', handleGalleryUploadClick);
        }
    });
</script>

<style>
    .form-row {
        display: flex;
        gap: 1.5rem;
    }
    
    .form-actions {
        margin-top: 2rem;
        display: flex;
        justify-content: flex-end;
    }

    .current-images-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .image-item {
        position: relative;
        border-radius: var(--radius-md);
        overflow: hidden;
        aspect-ratio: 16/9;
        border: 1px solid var(--admin-border);
    }

    .image-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .btn-remove-img {
        position: absolute;
        top: 5px;
        right: 5px;
        background: rgba(239, 68, 68, 0.9);
        color: white;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
    }

    @media (max-width: 768px) {
        .form-row {
            flex-direction: column;
            gap: 0;
        }
    }
</style>

</style>
