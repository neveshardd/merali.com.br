---
import Layout from '../../layouts/Layout.astro';

let errorMessage = '';
const MAX_ATTEMPTS = 5;
const LOCKOUT_TIME = 15 * 60 * 1000; // 15 minutes

// Simple in-memory rate limiting (in production, use Redis or database)
const loginAttemptsMap = new Map<string, { count: number; lastAttempt: number }>();

if (Astro.request.method === "POST") {
  try {
    const data = await Astro.request.formData();
    const password = data.get("password")?.toString();
    
    // Get client IP for rate limiting
    const clientIP = Astro.request.headers.get('x-forwarded-for') || 
                     Astro.request.headers.get('x-real-ip') || 
                     'unknown';
    
    // Check rate limiting
    const attempts = loginAttemptsMap.get(clientIP);
    const now = Date.now();
    
    if (attempts) {
      if (attempts.count >= MAX_ATTEMPTS && (now - attempts.lastAttempt) < LOCKOUT_TIME) {
        const remainingTime = Math.ceil((LOCKOUT_TIME - (now - attempts.lastAttempt)) / 60000);
        errorMessage = `Muitas tentativas. Tente novamente em ${remainingTime} minutos.`;
      } else if ((now - attempts.lastAttempt) > LOCKOUT_TIME) {
        // Reset after lockout period
        loginAttemptsMap.delete(clientIP);
      }
    }
    
    if (!errorMessage && password) {
      // Use environment variable for password (NEVER hardcode!)
      const ADMIN_PASSWORD = import.meta.env.ADMIN_PASSWORD || process.env.ADMIN_PASSWORD;
      
      if (!ADMIN_PASSWORD) {
        console.error('ADMIN_PASSWORD not set in environment variables!');
        errorMessage = 'Erro de configuração do servidor.';
      } else if (password === ADMIN_PASSWORD) {
        // Successful login - clear attempts
        loginAttemptsMap.delete(clientIP);
        
        // Generate a simple secure-ish token without relying on crypto.randomUUID
        const sessionToken = Math.random().toString(36).substring(2) + Date.now().toString(36);
        
        Astro.cookies.set("auth_token", sessionToken, { 
          path: "/",
          httpOnly: true,
          secure: import.meta.env.PROD,
          sameSite: 'strict', // CSRF protection
          maxAge: 60 * 60 * 24 * 7 // 1 week
        });
        
        return Astro.redirect("/admin");
      } else {
        // Failed login - increment attempts
        const currentAttempts = loginAttemptsMap.get(clientIP) || { count: 0, lastAttempt: now };
        loginAttemptsMap.set(clientIP, {
          count: currentAttempts.count + 1,
          lastAttempt: now
        });
        
        errorMessage = 'Senha incorreta.';
      }
    }
  } catch (error) {
    console.error('Login error:', error);
    errorMessage = 'Erro ao processar login.';
  }
}
---

<Layout title="Login Admin">
  <main class="login-container">
    <div class="login-box">
      <h1>Meralis Admin</h1>
      {errorMessage && (
        <div class="error-message">
          {errorMessage}
        </div>
      )}
      <form method="POST">
        <label>
          Senha de Acesso:
          <input type="password" name="password" required autocomplete="current-password" />
        </label>
        <button type="submit">Entrar</button>
      </form>
    </div>
  </main>
</Layout>

<style>
  .login-container {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    background: #f0f0f0;
    color: #333;
    font-family: sans-serif;
  }
  .login-box {
    background: white;
    padding: 2rem;
    border: 1px solid #ccc;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  h1 { margin-top: 0; font-size: 1.5rem; text-transform: uppercase; }
  .error-message {
    background: #fee;
    border: 1px solid #fcc;
    color: #c33;
    padding: 0.75rem;
    margin-bottom: 1rem;
    border-radius: 4px;
    font-size: 0.9rem;
  }
  label { display: block; margin-bottom: 1rem; }
  input { display: block; width: 100%; padding: 0.5rem; margin-top: 0.5rem; border: 1px solid #999; }
  button { 
    background: black; 
    color: white; 
    border: none; 
    padding: 0.5rem 1rem; 
    cursor: pointer; 
    text-transform: uppercase; 
    font-weight: bold;
    width: 100%;
  }
  button:hover { background: #333; }
</style>
