---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { getAllImages, deleteImageFile } from '../../../db/media_queries';
import { getProjects } from '../../../db/queries';

const cookie = Astro.cookies.get('auth_token');
if (!cookie) {
  return Astro.redirect('/admin/login');
}

// Data gathering
const imagesRaw = await getAllImages();
const projects = await getProjects();

// Filtering Logic
const filterProject = Astro.url.searchParams.get('project') || "all";
const showUnused = Astro.url.searchParams.get('unused') === 'true';

let filteredImages = imagesRaw;

if (showUnused) {
    filteredImages = filteredImages.filter(img => !img.projectId);
} else if (filterProject !== "all") {
    filteredImages = filteredImages.filter(img => img.projectId === filterProject);
}

// Handle Image Deletion
if (Astro.request.method === "POST") {
    const formData = await Astro.request.formData();
    const action = formData.get('action');
    
    if (action === 'delete') {
        const filename = formData.get('filename')?.toString();
        if (filename) {
            await deleteImageFile(filename);
            return Astro.redirect(Astro.url.pathname + Astro.url.search);
        }
    }
}
---

<AdminLayout title="Mídia">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <h1 style="margin: 0; font-size: 1.5rem;">Biblioteca de Mídia</h1>
        <div style="display: flex; gap: 1rem; align-items: center;">
            <form method="GET" style="display: flex; gap: 0.5rem; align-items: center;">
                <select name="project" onchange="this.form.submit()" style="padding: 0.4rem; border-radius: 4px; border: 1px solid var(--admin-border);">
                    <option value="all" selected={filterProject === "all"}>Todos os Projetos</option>
                    {projects.map(p => (
                        <option value={p.id} selected={filterProject === p.id}>{p.title}</option>
                    ))}
                </select>
                <label style="display: flex; align-items: center; gap: 0.3rem; font-size: 0.875rem;">
                    <input type="checkbox" name="unused" value="true" checked={showUnused} onchange="this.form.submit()" />
                    Não usadas
                </label>
            </form>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem;">
        {filteredImages.map((img) => (
            <div style="background: white; border: 1px solid var(--admin-border); border-radius: 4px; overflow: hidden; position: relative;">
                <img src={img.url} alt="" style="width: 100%; aspect-ratio: 1; object-fit: cover;" />
                <div style="padding: 0.5rem; font-size: 0.75rem;">
                    <div style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--admin-text-muted);">
                        {img.filename}
                    </div>
                </div>
                <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s;" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0">
                    <form method="POST" onsubmit="return confirm('Excluir arquivo?');">
                        <input type="hidden" name="action" value="delete" />
                        <input type="hidden" name="filename" value={img.filename} />
                        <button type="submit" class="btn btn-danger" style="padding: 0.3rem 0.6rem;">Excluir</button>
                    </form>
                </div>
            </div>
        ))}
    </div>

    {filteredImages.length === 0 && (
        <div style="padding: 4rem; text-align: center; color: var(--admin-text-muted);">
            Nenhuma imagem encontrada.
        </div>
    )}
</AdminLayout>
