---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { getProjects } from '../db/queries';
import { initDb } from '../db';

// Initialize DB and Seed if necessary
// In a real production app, this would be a separate migration step
try {
    initDb();
} catch (e) {
    // console.error("DB Init Error (might be already init):", e);
}

const dbProjects = await getProjects();

// Transform DB projects for display
// We default size/position since we don't store them in DB yet for simplicity
const projects = dbProjects.map((p, index) => {
    let images: string[] = [];
    try {
        images = JSON.parse(p.images || '[]');
    } catch {
        images = [p.images || ''];
    }

    // Simple pattern for grid logic
    // 0: wide, 1: tall, 2: normal, etc. just to make it look interesting
    const sizes = ['wide', 'tall', 'normal', 'normal', 'wide', 'tall', 'wide', 'normal'];
    const positions = ['center', 'left', 'right', 'top', 'bottom', 'center', 'left', 'right'];
    
    return {
        ...p,
        image: images[0] || '/hero-render.png',
        size: sizes[index % sizes.length],
        position: positions[index % positions.length]
    };
});
---

<Layout title="Projetos - Meralis Studio">
	<Header />
	<main>
		<section class="page-header">
			<div class="container">
				<h1>Nossos Projetos</h1>
				<p>Uma seleção de obras que traduzem nossa visão de arquitetura.</p>
                
                <div class="filters">
                    <button class="active">Todos</button>
                    <button>Residencial</button>
                    <button>Comercial</button>
                    <button>Interiores</button>
                </div>
			</div>
		</section>

		<section class="projects-grid-section">
			<div class="container">
				<div class="gallery">
					{projects.length > 0 ? projects.map((project) => (
						<a href={`/projetos/${project.slug}`} class={`project-item ${project.size}`} data-category={project.category}>
							<div class="image-wrapper">
								<img src={project.image} alt={project.title} style={`object-position: ${project.position};`} />
								<div class="overlay"></div>
								<div class="project-info">
                                    <span class="project-category">{project.category}</span>
									<span class="project-title">{project.title}</span>
								</div>
							</div>
						</a>
					)) : (
                        <div class="empty-state">
                            <h3>EM BREVE</h3>
                            <p>Novos projetos estão sendo fotografados e renderizados. Volte logo.</p>
                        </div>
                    )}
				</div>
			</div>
		</section>
	</main>
    <Footer />
</Layout>

<style>
	main {
		background-color: #13151a;
		min-height: 100vh;
        padding-top: 150px; /* Space for absolute header */
        padding-bottom: 8rem; /* Space before footer */
	}

	.container {
		max-width: 1100px;
		margin: 0 auto;
        padding: 0 2rem; /* Consistent padding */
	}

	.page-header {
		margin-bottom: 4rem;
        text-align: center;
	}

	h1 {
		font-size: 3rem;
		font-weight: 700;
		color: white;
		margin-bottom: 1rem;
		letter-spacing: 2px;
        text-transform: uppercase;
	}

	p {
		color: rgba(255, 255, 255, 0.6);
		font-size: 1.1rem;
		font-weight: 300;
        margin-bottom: 3rem;
	}

    .filters {
        display: flex;
        justify-content: center;
        gap: 2rem;
        flex-wrap: wrap;
    }

    .filters button {
        background: none;
        border: none;
        color: rgba(255, 255, 255, 0.5);
        font-family: inherit;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        cursor: pointer;
        padding-bottom: 5px;
        transition: all 0.3s ease;
        border-bottom: 1px solid transparent;
    }

    .filters button:hover, .filters button.active {
        color: white;
        border-bottom-color: white;
    }

	/* Masonry/Grid Layout - Reusing logic with slight tweaks */
	.gallery {
		display: grid;
		grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
		grid-auto-rows: 320px;
		gap: 1.5rem;
		grid-auto-flow: dense;
	}

	.project-item.wide {
		grid-column: span 2;
	}

	.project-item.tall {
		grid-row: span 2;
	}

	.project-item {
		display: block;
		position: relative;
		overflow: hidden;
		background-color: #222;
        height: 100%;
        width: 100%;
	}

	.image-wrapper {
		width: 100%;
		height: 100%;
		position: relative;
		transition: transform 0.6s cubic-bezier(0.2, 1, 0.2, 1);
	}

	.project-item:hover .image-wrapper {
		transform: scale(1.03);
	}

	.project-item img {
		width: 100%;
		height: 100%;
		object-fit: cover;
		transition: filter 0.3s ease;
		filter: grayscale(20%);
	}

	.project-item:hover img {
		filter: grayscale(0%);
	}

	.overlay {
		position: absolute;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 50%);
		opacity: 0.6;
		transition: opacity 0.3s ease;
	}

	.project-item:hover .overlay {
		opacity: 0.8;
	}

    .project-info {
        position: absolute;
		bottom: 1.5rem;
		right: 1.5rem;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        z-index: 2;
    }

    .project-category {
        font-size: 0.7rem;
        color: rgba(255, 255, 255, 0.7);
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 0.3rem;
        transform: translateY(10px);
        opacity: 0;
        transition: all 0.3s ease;
    }

	.project-title {
		font-size: 0.9rem;
		font-weight: 600;
		letter-spacing: 1.5px;
		color: white;
		text-transform: uppercase;
		text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
	}

    .project-item:hover .project-category {
        transform: translateY(0);
        opacity: 1;
    }

	/* Responsive Adjustments */
    @media (max-width: 1150px) {
        .wide {
            /* On smaller tablets, keep wide but maybe adjust grid cols handled by auto-fill */
        }
    }

	@media (max-width: 768px) {
        main {
            padding-top: 100px;
        }

		.gallery {
			grid-template-columns: 1fr;
			grid-auto-rows: 300px;
		}

		.project-item.wide, 
		.project-item.tall {
			grid-column: span 1;
			grid-row: span 1;
		}
        
        h1 {
            font-size: 2rem;
        }
	}

    .empty-state {
        grid-column: 1 / -1;
        padding: 4rem;
        text-align: center;
        border: 1px dashed rgba(255,255,255,0.1);
        border-radius: 4px;
        background: rgba(255,255,255,0.02);
    }

    .empty-state h3 {
        font-size: 1.5rem;
        margin-bottom: 1rem;
        color: white;
        letter-spacing: 2px;
    }

    .empty-state p {
        margin-bottom: 0;
        opacity: 0.6;
    }
</style>

<script>
    const filterButtons = document.querySelectorAll('.filters button');
    const projectItems = document.querySelectorAll('.project-item');

    filterButtons.forEach(button => {
        button.addEventListener('click', () => {
            // Remove active class from all buttons
            filterButtons.forEach(btn => btn.classList.remove('active'));
            // Add active class to clicked button
            button.classList.add('active');

            const filterValue = button.textContent?.trim().toLowerCase();

            projectItems.forEach(item => {
                const category = item.getAttribute('data-category')?.toLowerCase();
                
                if (filterValue === 'todos' || category === filterValue) {
                    (item as HTMLElement).style.display = 'block';
                } else {
                    (item as HTMLElement).style.display = 'none';
                }
            });
        });
    });
</script>
