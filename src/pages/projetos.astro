---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { getProjectsFromCRM } from '../lib/crm';
import ProjectModal from '../components/ProjectModal.astro';

const dbProjects = await getProjectsFromCRM();

// Transform DB projects for display with grid logic
const projects = dbProjects.map((p, index) => {
    // ... logic remains same ...
    let images: string[] = [];
    try { images = JSON.parse(p.images || '[]'); } catch { images = [p.images || '']; }
    
    // ...
    // Pass visual props used in template
    const sizes = ['wide', 'tall', 'normal', 'normal', 'wide', 'tall', 'wide', 'normal'];
    const positions = ['center', 'left', 'right', 'top', 'bottom', 'center', 'left', 'right'];

    return {
        ...p,
        image: images[0] || '/hero-render.png',
        size: sizes[index % sizes.length],
        position: positions[index % positions.length]
    };
});
---

<Layout title="Projetos - Meralis Studio">
	<Header />
    <ProjectModal projects={projects} />
	<main>
		<section class="page-header">

			<div class="container">
				<h1>Nossos Projetos</h1>
				<p>Uma seleção de obras que traduzem nossa visão de arquitetura.</p>
                
                <div class="filters">
                    <button class="active">Todos</button>
                    <button>Residencial</button>
                    <button>Comercial</button>
                    <button>Interiores</button>
                </div>
			</div>
		</section>

		<section class="projects-grid-section">
			<div class="container">
		<div class={`gallery ${projects.length <= 2 ? 'few-items' : ''}`}>
					{projects.length > 0 ? projects.map((project) => (
						<div class={`project-item ${project.size}`} data-category={project.category} onclick={`window.openProjectModal('${project.id}')`}>
							<div class="image-wrapper">
								<img src={project.image} alt={project.title} style={`object-position: ${project.position};`} />
								<div class="overlay"></div>
								<div class="project-info">
                                    <span class="project-category">{project.category}</span>
									<span class="project-title">{project.title}</span>
								</div>
							</div>
						</div>
					)) : (
                        <div class="empty-state">
                            <h3>EM BREVE</h3>
                            <p>Novos projetos estão sendo fotografados e renderizados. Volte logo.</p>
                        </div>
                    )}
				</div>
			</div>
		</section>
	</main>
    <Footer />
</Layout>

<style>
	main {
		background-color: #13151a;
		min-height: 100vh;
        padding-top: 150px; /* Space for absolute header */
        padding-bottom: 8rem; /* Space before footer */
	}

	.container {
		max-width: 1100px;
		margin: 0 auto;
        padding: 0 2rem; /* Consistent padding */
	}

	.page-header {
		margin-bottom: 4rem;
        text-align: center;
	}

	h1 {
		font-size: 3rem;
		font-weight: 700;
		color: white;
		margin-bottom: 1rem;
		letter-spacing: 2px;
        text-transform: uppercase;
	}

	p {
		color: rgba(255, 255, 255, 0.6);
		font-size: 1.1rem;
		font-weight: 300;
        margin-bottom: 3rem;
	}

    .filters {
        display: flex;
        justify-content: center;
        gap: 2rem;
        flex-wrap: wrap;
    }

    .filters button {
        background: none;
        border: none;
        color: rgba(255, 255, 255, 0.5);
        font-family: inherit;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        cursor: pointer;
        padding-bottom: 5px;
        transition: all 0.3s ease;
        border-bottom: 1px solid transparent;
    }

    .filters button:hover, .filters button.active {
        color: white;
        border-bottom-color: white;
    }

	/* Grid Layout 4 Colunas */
	.gallery {
		display: grid;
		grid-template-columns: repeat(4, 1fr);
		gap: 1.5rem;
        align-items: start;
	}

    /* Ajuste dinâmico para poucos itens */
    .gallery.few-items {
        grid-template-columns: repeat(2, 1fr);
    }

	.project-item.wide {
		/* grid-column: span 2; - Removido */
	}

	.project-item.tall {
		/* grid-row: span 2; - Removido */
	}

	.project-item {
		display: block;
		position: relative;
		overflow: hidden;
		background-color: #222;
        /* height: 100%; - Removido para permitir altura natural */
        width: 100%;
        border-radius: 4px;
	}

	.image-wrapper {
		width: 100%;
		/* height: 100%; - Removido */
		position: relative;
		transition: transform 0.6s cubic-bezier(0.2, 1, 0.2, 1);
        font-size: 0;
	}

	.project-item:hover .image-wrapper {
		transform: scale(1.03);
	}

	.project-item img {
		width: 100%;
		height: auto; /* Altura natural */
		object-fit: cover;
		transition: transform 0.3s ease;
        display: block;
	}

	.project-item:hover img {
	}

	.overlay {
		position: absolute;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 50%);
		opacity: 0;
		transition: opacity 0.3s ease;
	}

	.project-item:hover .overlay {
		opacity: 1;
	}

    .project-info {
        position: absolute;
		bottom: 1.5rem;
		left: 1.5rem; /* Adicionado para limitar largura */
		right: 1.5rem;
        display: flex;
        flex-direction: column;
        align-items: flex-start; /* Mudado para esquerda para melhor leitura de títulos longos */
        z-index: 2;
        pointer-events: none;
    }

    .project-category {
        font-size: 0.7rem;
        color: rgba(255, 255, 255, 0.7);
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 0.3rem;
        transform: translateY(10px);
        opacity: 0;
        transition: all 0.3s ease;
    }

	.project-title {
		font-size: 0.9rem;
		font-weight: 600;
		letter-spacing: 1.5px;
		color: white;
		text-transform: uppercase;
		text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        margin: 0;
        
        /* Ensure full title is shown and wraps */
        display: block !important;
        white-space: normal !important;
        overflow-wrap: break-word !important;
        word-wrap: break-word !important;
        word-break: break-word !important;
        line-height: 1.3;
        text-align: left;
	}


    .project-item:hover .project-category {
        transform: translateY(0);
        opacity: 1;
    }

	/* Responsive Adjustments */
    @media (max-width: 1200px) {
        .gallery {
            grid-template-columns: repeat(3, 1fr);
        }
    }

	@media (max-width: 900px) {
		.gallery {
			grid-template-columns: repeat(2, 1fr);
		}
	}

    @media (max-width: 600px) {
		.gallery {
			grid-template-columns: 1fr;
		}
	}

	.empty-gallery {
        grid-column: 1 / -1;
    }
        
        h1 {
            font-size: 2rem;
        }
	}

    .empty-state {
        grid-column: 1 / -1;
        padding: 4rem;
        text-align: center;
        border: 1px dashed rgba(255,255,255,0.1);
        border-radius: 4px;
        background: rgba(255,255,255,0.02);
    }

    .empty-state h3 {
        font-size: 1.5rem;
        margin-bottom: 1rem;
        color: white;
        letter-spacing: 2px;
    }

    .empty-state p {
        margin-bottom: 0;
        opacity: 0.6;
    }
</style>

<script>
    const filterButtons = document.querySelectorAll('.filters button');
    const projectItems = document.querySelectorAll('.project-item');

    // Helper to normalize strings (remove accents, lowercase)
    const normalize = (str) => {
        return str?.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim() || '';
    };

    filterButtons.forEach(button => {
        button.addEventListener('click', () => {
            // Remove active class from all buttons
            filterButtons.forEach(btn => btn.classList.remove('active'));
            // Add active class to clicked button
            button.classList.add('active');

            const filterValue = normalize(button.textContent);
            console.log('Filter Value:', filterValue);

            projectItems.forEach(item => {
                const category = normalize(item.getAttribute('data-category'));
                console.log('Item Category:', category);
                
                if (filterValue === 'todos' || category.includes(filterValue) || filterValue.includes(category)) {
                    (item as HTMLElement).style.display = 'block';
                } else {
                    (item as HTMLElement).style.display = 'none';
                }
            });
        });
    });
</script>
